#!/bin/bash

source /usr/lib/ayer/functions.sh

target_feature=$1
target_branch=$2

cd_to_hoy_top

if [ -n "$target_branch" ]; then
    target_branch=${target_branch%_trunk}_trunk
else
    target_branch=$BRANCH
fi

[ -n "$target_feature" -a -n "$target_branch" ] || die "usage: $(basename $0) feature [branch]"

if git rev-parse "$target_feature" &>/dev/null; then
    # the feature already exists - just checkout
    git checkout "$target_feature"
    git submodule foreach git checkout "$target_feature"
    exit 0
fi

if ! git rev-parse "origin/$target_branch" &>/dev/null; then
    die "trunk \`$target_branch' is not found"
fi
if [ -f .ayer ]; then
    sed -i '/^BRANCH=/d' .ayer
fi
echo "BRANCH=$target_branch" >> .ayer

git checkout -t -B "$target_feature" "origin/$target_branch"
git submodule foreach git checkout -t -B "$target_feature" "origin/$target_branch"
